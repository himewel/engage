[
    {
        "$lookup": {
            "from": "roundScores",
            "localField": "userId",
            "foreignField": "_id.userId",
            "as": "roundScores"
        }
    },
    {
        "$unwind": {
            "path": "$round"
        }
    },
    {
        "$lookup": {
            "from": "groups",
            "localField": "groupId",
            "foreignField":"groupId",
            "as": "groups"
        }
    },
    {
        "$unwind": {
            "path": "$groups"
        }
    },
    {
        "$project": {
            "_id": {
                "userId": "$round._id.userId",
                "roundId": "$round._id.roundId",
                "groupId": "$groupId"
            },
            "groupName": "$groups.groupName",
            "userName": "$userName",
            "image": "$image",
            "round": "$round",
            "roundScore": "$round.roundScore"
        }
    },
    {
        "$setWindowFields": {
            "partitionBy": "$_id.roundId",
            "sortBy": {
                "roundScore": -1
            },
            "output": {
                "rank": {
                    "$rank": {}
                }
            }
        }
    },
    {
        "$merge": {
            "into": "userScores",
            "on": [
                "_id"
            ],
            "whenMatched": "replace"
        }
    }
]
